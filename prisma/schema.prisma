generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  player       Player?
}

model Player {
  id         String   @id @default(uuid())
  accountId  String   @unique
  name       String   @unique
  faction    String
  gold       Int      @default(0)
  population Int      @default(0)
  createdAt  DateTime @default(now())

  account      Account          @relation(fields: [accountId], references: [id])
  cities       City[]
  armies       Army[]
  hero         Hero?
  stats        PlayerStats?
  sentReports  BattleReport[]   @relation("Attacker")
  recvReports  BattleReport[]   @relation("Defender")
  spyReports   SpyReport[]
  marketOffers MarketOffer[]
  alliance     AllianceMember?
  expeditions  Expedition[]
}

model PlayerStats {
  id           String @id @default(uuid())
  playerId     String @unique
  attacksWon   Int    @default(0)
  defensesWon  Int    @default(0)
  unitsKilled  Int    @default(0)
  unitsLost    Int    @default(0)
  raidsWon     Int    @default(0)

  player Player @relation(fields: [playerId], references: [id])
}

model City {
  id        String   @id @default(uuid())
  playerId  String
  name      String
  x         Int
  y         Int
  isCapital Boolean  @default(false)

  wood  Float @default(500)
  stone Float @default(500)
  iron  Float @default(500)
  food  Float @default(500)

  maxStorage     Int @default(1000)
  maxFoodStorage Int @default(1000)

  wallHp       Int      @default(1000)
  wallMaxHp    Int      @default(1000)
  isSieged     Boolean  @default(false)
  siegeStarted DateTime?

  createdAt DateTime @default(now())

  player       Player             @relation(fields: [playerId], references: [id])
  buildings    CityBuilding[]
  buildQueue   BuildQueueItem[]
  recruitQueue RecruitQueueItem[]
  armies       Army[]

  @@unique([x, y])
  @@index([playerId])
  @@map("City")
}

model CityBuilding {
  id          String @id @default(uuid())
  cityId      String
  slot        Int
  key         String
  level       Int    @default(1)
  category    String @default("BASE")
  prodPerHour Int    @default(0)

  city City @relation(fields: [cityId], references: [id])

  @@unique([cityId, slot])
  @@index([cityId, key])
}

model BuildQueueItem {
  id          String   @id @default(uuid())
  cityId      String
  slot        Int
  buildingKey String
  targetLevel Int
  startedAt   DateTime
  endsAt      DateTime
  status      String   @default("QUEUED")

  city City @relation(fields: [cityId], references: [id])

  @@index([cityId, status])
  @@index([status, endsAt])
}

model RecruitQueueItem {
  id          String   @id @default(uuid())
  cityId      String
  unitKey     String
  count       Int
  buildingKey String
  startedAt   DateTime
  endsAt      DateTime
  status      String   @default("RUNNING")

  city City @relation(fields: [cityId], references: [id])

  @@index([status, endsAt])
}

model Army {
  id         String  @id @default(uuid())
  ownerId    String
  playerId   String?
  cityId     String?
  name       String
  slot       Int     @default(0)
  x          Int
  y          Int
  status     String  @default("IDLE")
  heroId     String? @unique
  isGarrison Boolean @default(false)

  targetX          Int?
  targetY          Int?
  targetCityId     String?
  targetResourceId String?
  arrivesAt        DateTime?
  arrivalAt        DateTime?
  returnsAt        DateTime?

  mission     String?
  missionType String?
  carryWood   Int     @default(0)
  carryStone  Int     @default(0)
  carryIron   Int     @default(0)
  carryFood   Int     @default(0)

  // Récolte progressive
  harvestStartedAt DateTime?  // Quand la récolte a commencé
  harvestResourceType String? // Type de ressource en cours de récolte

  owner Player     @relation(fields: [ownerId], references: [id])
  city  City?      @relation(fields: [cityId], references: [id])
  hero  Hero?      @relation(fields: [heroId], references: [id])
  units ArmyUnit[]

  @@index([ownerId])
  @@index([cityId])
  @@index([status, arrivalAt])
  @@index([targetCityId])
}

model ArmyUnit {
  id      String @id @default(uuid())
  armyId  String
  unitKey String
  tier    String @default("base")
  count   Int

  army Army @relation(fields: [armyId], references: [id])

  @@unique([armyId, unitKey])
}

model Hero {
  id       String @id @default(uuid())
  playerId String @unique
  ownerId  String?
  name     String
  level    Int    @default(1)
  xp       Int    @default(0)
  xpToNextLevel Int @default(100)

  attack    Int @default(5)
  defense   Int @default(5)
  logistics Int @default(5)
  speed     Int @default(5)

  atkPoints  Int @default(0)
  defPoints  Int @default(0)
  spdPoints  Int @default(0)
  logPoints  Int @default(0)
  statPoints Int @default(5)
  freePoints Int @default(0)

  player Player @relation(fields: [playerId], references: [id])
  army   Army?
  items  HeroItem[]
}

model HeroItem {
  id       String @id @default(uuid())
  heroId   String
  itemKey  String
  slot     String
  stats    Json?

  hero Hero @relation(fields: [heroId], references: [id])
}

model WoundedUnit {
  id      String   @id @default(uuid())
  cityId  String
  unitKey String
  count   Int
  healsAt DateTime

  @@unique([cityId, unitKey])
}

model BattleReport {
  id             String   @id @default(uuid())
  playerId       String?
  attackerId     String?
  defenderId     String?
  x              Int
  y              Int
  result         String?
  winner         String?
  attackerUnits  Json?
  defenderUnits  Json?
  attackerLosses Json?
  defenderLosses Json?
  attackerLost   Json?
  defenderLost   Json?
  loot           Json?
  rounds         Json?
  createdAt      DateTime @default(now())

  attacker Player? @relation("Attacker", fields: [attackerId], references: [id])
  defender Player? @relation("Defender", fields: [defenderId], references: [id])

  @@index([playerId, createdAt])
}

model SpyReport {
  id             String   @id @default(uuid())
  playerId       String
  ownerId        String?
  targetPlayerId String?
  targetCityId   String?
  targetType     String?
  targetX        Int
  targetY        Int
  targetName     String?
  cityName       String?
  success        Boolean
  buildings      Json?
  armies         Json?
  resources      Json?
  data           Json?
  createdAt      DateTime @default(now())

  player Player @relation(fields: [playerId], references: [id])

  @@index([playerId, createdAt])
}

model ResourceNode {
  id           String   @id @default(uuid())
  x            Int
  y            Int
  resourceType String
  level        Int      @default(1)  // 1, 2, 3 (3 = richest, near center)
  amount       Int      @default(1000)
  maxAmount    Int      @default(1000)
  regenRate    Int      @default(10)
  lastRegen    DateTime @default(now())
  biome        String   @default("forest") // forest, desert, snow

  // Tribus locales défenseurs
  hasDefenders    Boolean @default(true)
  defenderPower   Int     @default(100)    // Puissance totale des défenseurs
  defenderUnits   Json?                     // Ex: {"warrior": 20, "archer": 10}
  lastDefeat      DateTime?                 // Dernière défaite (respawn après X temps)
  respawnMinutes  Int     @default(60)      // Temps de respawn des défenseurs

  // Système de régénération lié aux armées
  lastArmyDeparture DateTime?              // Quand la dernière armée a quitté le point
  hasPlayerArmy     Boolean @default(false) // Une armée joueur est présente sur le point

  @@unique([x, y])
  @@index([hasDefenders, lastDefeat])
  @@index([hasPlayerArmy])
}

model MarketOffer {
  id           String   @id @default(uuid())
  playerId     String?
  sellerId     String?
  buyerId      String?
  cityId       String?
  sellResource String
  sellAmount   Int
  buyResource  String
  buyAmount    Int
  status       String   @default("ACTIVE")
  createdAt    DateTime @default(now())

  player Player? @relation(fields: [playerId], references: [id])

  @@index([status])
  @@index([sellerId])
}

model Alliance {
  id          String   @id @default(uuid())
  name        String   @unique
  tag         String   @unique
  description String?
  leaderId    String?
  createdAt   DateTime @default(now())

  members   AllianceMember[]
  diplomacy AllianceDiplomacy[] @relation("AllianceSource")
  targetOf  AllianceDiplomacy[] @relation("AllianceTarget")
}

model AllianceMember {
  id         String   @id @default(uuid())
  allianceId String
  playerId   String   @unique
  ownerId    String?
  role       String   @default("MEMBER")
  joinedAt   DateTime @default(now())

  alliance Alliance @relation(fields: [allianceId], references: [id])
  player   Player   @relation(fields: [playerId], references: [id])
}

model AllianceDiplomacy {
  id               String   @id @default(uuid())
  allianceId       String
  targetAllianceId String
  status           String   @default("NEUTRAL")
  changedAt        DateTime @default(now())

  alliance       Alliance @relation("AllianceSource", fields: [allianceId], references: [id])
  targetAlliance Alliance @relation("AllianceTarget", fields: [targetAllianceId], references: [id])

  @@unique([allianceId, targetAllianceId])
}

model Expedition {
  id         String    @id @default(uuid())
  playerId   String
  ownerId    String?
  armyId     String?
  difficulty Int
  enemyPower Int
  duration   Int       @default(1800)
  lootTier   String    @default("COMMON")
  rewards    Json?
  expiresAt  DateTime
  startedAt  DateTime?
  endsAt     DateTime?
  status     String    @default("AVAILABLE")
  won        Boolean?
  xpGained   Int?
  lootGained Json?
  createdAt  DateTime  @default(now())

  player Player @relation(fields: [playerId], references: [id])

  @@index([playerId, status])
  @@index([status, endsAt])
}
